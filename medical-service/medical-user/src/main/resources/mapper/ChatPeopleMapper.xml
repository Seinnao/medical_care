<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.whz.mapper.ChatPeopleMapper">

    <select id="findAllByNickname" resultType="com.whz.entity.ChatPeople">
    select p.id,p.nickname,p.other_party,avatar_url,max(m.content) as content,max(m.time) as time,
           count(case when m.state=0
                   then 1
                   else null
                   end) as unread_msg
    from chat_people p
    left join chat_message m
    on p.nickname = m.reach and p.other_party = m.come
    where p.nickname = #{name}
    group by p.id order by max(m.time) desc
    </select>
</mapper>
